# API Documentation

**English | [简体中文](./API_CN.md)**

## `debug`

Debug scripts. Two arguments accepted, which are script code string `script` and script debug id `debuggerId`, respectively.

The `script` can be not only the source code, but also the transformed result generated by the `transform` method. And the `debuggerId` is the script url normally. If missing `debuggerId`, the debugging script will be treated as a temporary script, and a random `debuggerId` will be generated.

This method returns an execution function called `run`, for code real execution. Therefore, before `run` calls, you can use other APIs like `setBreakpoint` to modify breakpoints. If inputed arguments is invalid, or current environment does't support debug, this method returns `false`.

```ts
function debug(script: string, debuggerId?: string): (() => void) | false
```

## `transform`

Transform scripts. Two arguments accepted, which are script code string `script` and script debug id `debuggerId`, respectively.

The `debuggerId` is the script url normally. If missing `debuggerId`, the debugging script will be treated as a temporary script, and a random `debuggerId` will be generated.

This method returns a code transformed result, which can be passed to the `debug` method for debugging scripts at runtime. If inputed arguments is invalid, this method returns `false`.

```ts
function transform(script: string, debuggerId?: string): string | false
```

## `resume`

Resume execution when paused by hitting breakpoints. One optional argument accepted, which can be `stepInto`, `stepOver` or `stepOut`:

1. continue executing by default if missing 
2. step into child process if passing `stepInto`
3. step over child process if passing `stepOver`
4. step out to parent process if passing `stepOut`

This method returns a boolean value to inform whether resume succeeds.

```ts
function resume(type?: ResumeType): boolean

type ResumeType = 'stepInto' | 'stepOver' | 'stepOut'
```

## `evaluate`

Evaluate expressions in the specific scope. Two arguments accepted, which are expression code string `expression` and call frame id `callFrameId`, respectively.

The `callFrameId` is optional, which can be achieved from the `scopeChain` of paused info, by `getPausedInfo` method or `paused` event. If `callFrameId` inputed, the `expression` will be evaluated in the corresponding scope. Or, if `callFrameId` missed, the `expression` will be evaluated in the global scope.

```ts
function evaluate<Result = unknown>(expression: string, callFrameId?: number): Result | false
```

## `setBreakpoint`

Set breakpoints by script debug id. Three arguments accepted, which are script debug id `debuggerId`, line number `lineNumber` and optional break condition `condition`.

The `condition` is an expression string, and execution will be paused if the evaluation returns `true`. If `condition` missed, execution will be paused when hitting the corresponding line defined by `lineNumber`, by default.

If set succeeds, this method returns the breakpoint info, including breakpoint id `id` and exact break line number `lineNumber`. Or, if set fails, this method returns `false`.

```ts
function setBreakpoint(debuggerId: string, lineNumber: number, condition?: string): Breakpoint | false

interface Breakpoint { id: number, lineNumber: number }
```

## `removeBreakpoint`

Remove breakpoint by breakpoint id. One breakpoint id argument accepted.

This method returns a boolean value to inform whether remove succeeds.

```ts
function removeBreakpoint(id: number): boolean
```

## `setBreakpointsActive`

Set whether all breakpoints are active. One boolean argument accepted.

This method returns a boolean value to inform whether breakpoints are active.

```ts
function setBreakpointsActive(value: boolean): boolean
```

## `setExecutionPause`

Set whether execution pauses. One boolean argument accepted.

This method returns a boolean value to inform whether execution will pause. If the return is `true`, execution will pause at the next coming step.

```ts
function setExecutionPause(value: boolean): boolean
```

## `setExceptionPause`

Set whether execution pauses when exception. One boolean argument accepted.

This method returns a boolean value to inform whether execution will pause when exception. If the return is `true`, execution will pause right before the exception thro

```ts
function setExceptionPause(value: boolean): boolean
```

## `getPausedInfo`

获取断点信息。当目前处于暂停状态时，返回的当前断点相关信息，包括调试ID `debuggerId`、断点ID `breakpointId`、行号 `lineNumber`、列号 `columnNumber`、作用域链 `scopeChain` 以及调试源码 `scriptContent`。当目前没有处在暂停状态时，返回 `false`。

其中，作用域链 `scopeChain` 包括全局、函数和块级作用域，可通过是否有调用帧 `callFrame` 字段来判断是否是全局或函数作用域。过滤出作用域链中含有调用帧的作用域，即可获得调用栈。

另外，调用帧 `callFrame` 中的 `callFrameId` 可传给 `evaluate` 接口用于在特定作用域下执行脚本。

```ts
function getPausedInfo(): PausedInfo | false

interface PausedInfo { breakpointId?: number, reason?: string, data?: any, debuggerId: string, lineNumber: number, columnNumber: number, scopeChain: Scope[], scriptContent: string }
interface Scope { eval: (expression: string) => any, name: string, callFrameId: number, callFrame?: CallFrame }
interface CallFrame { debuggerId: string, lineNumber: number, columnNumber: number }
```

## `getScopeChain`

Get current scope chain.

```ts
function getScopeChain(): Scope[]

interface Scope { eval: (expression: string) => any, name: string, callFrameId: number, callFrame?: CallFrame }
interface CallFrame { debuggerId: string, lineNumber: number, columnNumber: number }
```

## `getScriptContent`

Get script source content by debugger id `debuggerId`.

```ts
function getScriptContent(debuggerId: string): string
```

## `runInNativeEnv`

在原生环境中执行。调试器默认将脚本在内部的沙盒中运行，该接口用于在调试过程中，执行需要在原生环境下运行的代码。如果执行成功，该接口返回值为回调函数的返回值；如果执行失败，返回 `false`。

```ts
function runInNativeEnv(callback: () => Return): Return | false
```

## `runInSkipOver`

跳过断点执行。当命中断点暂停时，如果执行调试脚本，会被阻塞直至断点恢复，该接口用于在暂停情况下，不阻塞直接执行调试脚本，常用于通过 `evaluate` 接口调用调试脚本时，不阻塞执行以获取相应作用域中的值。如果执行成功，该接口返回值为回调函数的返回值；如果执行失败，返回 `false`。

```ts
function runInSkipOver(callback: () => Return): Return | false
```

## `setModuleRequest`

设置模块请求函数。当需要import模块时，内部默认会使用fetch进行请求。如果在不支持fetch的环境使用，或者想自定义模块请求的行为（比如对请求结果进行缓存），可通过该接口进行设置。该接口接受一个请求函数 `request` 作为参数，并返回的布尔值告知是否设置成功。其中，请求函数 `request` 可接受一个模块地址 `importUrl` 作为入参，并要求返回一个 `Promise<string>` 包裹的模块脚本文本内容。而模块脚本文本内容可以是转换前的脚本源码字符串，也可以是通过 `transform` 接口转换后的脚本字符串。

```ts
function setModuleRequest(request: (importUrl: string) => Promise<string>): boolean
```

## `addEventListener` 和 `removeEventListener`

添加或移除事件监听器，接受两个参数，分别是事件 `event` 和监听函数 `listener`。目前有四个事件，为暂停 `paused`、恢复 `resumed`、错误 `error` 和沙盒状态变化 `sandboxchange`。其中，暂停事件会返回断点相关信息，该信息与 `getPausedInfo` 的返回值一致；错误事件会返回错误相关信息，包括错误原因和作用域链；沙盒状态变化事件会返回沙盒相关信息，包括是否启用了沙盒。该接口返回的布尔值用于标记是否添加或移除事件监听器成功。

```ts
function addEventListener<Event extends keyof EventListener>(event: Event, listener: EventListener[Event]): boolean
function removeEventListener<Event extends keyof EventListener>(event: Event, listener: EventListener[Event]): boolean

interface EventListener {
  resumed: () => void,
  paused: (pausedInfo: PausedInfo) => void,
  error: (errorInfo: ErrorInfo) => void,
  sandboxchange: (sandboxInfo: SandboxInfo) => void,
}
interface PausedInfo { breakpointId?: number, reason?: string, data?: any, debuggerId: string, lineNumber: number, columnNumber: number, scopeChain: Scope[], scriptContent: string }
interface ErrorInfo { error: Error, scopeChain: Scope[] }
interface SandboxInfo { enable: boolean }
interface Scope { eval: (expression: string) => any, name: string, callFrameId: number, callFrame?: CallFrame }
interface CallFrame { debuggerId: string, lineNumber: number, columnNumber: number }
```

